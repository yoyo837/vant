import{A as N,e as r,y as F,I as Y,j,v as D,B as Z,q as $,H as ee}from"./vue-libs-19c20d28.js";import{c as ae,D as E,B as le,n as T,i as te,e as x,G as ne,v as re,p as k}from"./use-translate-71d4880c.js";import{u as oe}from"./use-expose-80cfd2b2.js";import{I as C}from"./index-1ef61aa2.js";import{I as ie}from"./index-1122429d.js";import{L as se}from"./index-2b75ebd8.js";import{n as ce,d as ue,c as B,m as U,t as R,b as de,w as fe}from"./with-install-560d59bf.js";import{c as ve}from"./interceptor-5424332a.js";import{s as me}from"./function-call-6ab5e59b.js";const[ge,o,pe]=ae("uploader");function O(e,t){return new Promise(i=>{if(t==="file"){i();return}const c=new FileReader;c.onload=v=>{i(v.target.result)},t==="dataUrl"?c.readAsDataURL(e):t==="text"&&c.readAsText(e)})}function M(e,t){return E(e).some(i=>i.file?le(t)?t(i.file):i.file.size>+t:!1)}function we(e,t){const i=[],c=[];return e.forEach(v=>{M(v,t)?c.push(v):i.push(v)}),{valid:i,invalid:c}}const be=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,he=e=>be.test(e);function G(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?he(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}const ye=N({props:{name:ce,item:ue(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:t,slots:i}){const c=()=>{const{status:n,message:f}=e.item;if(n==="uploading"||n==="failed"){const m=n==="failed"?r(C,{name:"close",class:o("mask-icon")},null):r(se,{class:o("loading")},null),d=te(f)&&f!=="";return r("div",{class:o("mask")},[m,d&&r("div",{class:o("mask-message")},[f])])}},v=n=>{const{name:f,item:m,index:d,beforeDelete:I}=e;n.stopPropagation(),ve(I,{args:[m,{name:f,index:d}],done:()=>t("delete")})},g=()=>t("preview"),y=()=>t("reupload"),p=()=>{if(e.deletable&&e.item.status!=="uploading"){const n=i["preview-delete"];return r("div",{role:"button",class:o("preview-delete",{shadow:!n}),tabindex:0,"aria-label":pe("delete"),onClick:v},[n?n():r(C,{name:"cross",class:o("preview-delete-icon")},null)])}},h=()=>{if(i["preview-cover"]){const{index:n,item:f}=e;return r("div",{class:o("preview-cover")},[i["preview-cover"](x({index:n},f))])}},P=()=>{const{item:n,lazyLoad:f,imageFit:m,previewSize:d,reupload:I}=e;return G(n)?r(ie,{fit:m,src:n.objectUrl||n.content||n.url,class:o("preview-image"),width:Array.isArray(d)?d[0]:d,height:Array.isArray(d)?d[1]:d,lazyLoad:f,onClick:I?y:g},{default:h}):r("div",{class:o("file"),style:T(e.previewSize)},[r(C,{class:o("file-icon"),name:"description"},null),r("div",{class:[o("file-name"),"van-ellipsis"]},[n.file?n.file.name:n.url]),h()])};return()=>r("div",{class:o("preview")},[P(),c(),p()])}}),Ie={name:B(""),accept:U("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:B(1/0),imageFit:U("cover"),resultType:U("dataUrl"),uploadIcon:U("photograph"),uploadText:String,deletable:R,reupload:Boolean,afterRead:Function,showUpload:R,modelValue:de(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:R,previewOptions:Object,previewFullImage:R,maxSize:{type:[Number,String,Function],default:1/0}},Pe=N({name:ge,props:Ie,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:t,slots:i}){const c=F(),v=[],g=F(-1),y=F(!1),p=(a=e.modelValue.length)=>({name:e.name,index:a}),h=()=>{c.value&&(c.value.value="")},P=a=>{if(h(),M(a,e.maxSize))if(Array.isArray(a)){const l=we(a,e.maxSize);if(a=l.valid,t("oversize",l.invalid,p()),!a.length)return}else{t("oversize",a,p());return}if(a=ee(a),g.value>-1){const l=[...e.modelValue];l.splice(g.value,1,a),t("update:modelValue",l),g.value=-1}else t("update:modelValue",[...e.modelValue,...E(a)]);e.afterRead&&e.afterRead(a,p())},n=a=>{const{maxCount:l,modelValue:u,resultType:s}=e;if(Array.isArray(a)){const w=+l-u.length;a.length>w&&(a=a.slice(0,w)),Promise.all(a.map(b=>O(b,s))).then(b=>{const W=a.map((A,L)=>{const S={file:A,status:"",message:"",objectUrl:URL.createObjectURL(A)};return b[L]&&(S.content=b[L]),S});P(W)})}else O(a,s).then(w=>{const b={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};w&&(b.content=w),P(b)})},f=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const u=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(u,p());if(!s){h();return}if(re(s)){s.then(w=>{n(w||u)}).catch(h);return}}n(u)};let m;const d=()=>t("closePreview"),I=a=>{if(e.previewFullImage){const l=e.modelValue.filter(G),u=l.map(s=>(s.objectUrl&&!s.url&&s.status!=="failed"&&(s.url=s.objectUrl,v.push(s.url)),s.url)).filter(Boolean);m=me(x({images:u,startPosition:l.indexOf(a),onClose:d},e.previewOptions))}},q=()=>{m&&m.close()},_=(a,l)=>{const u=e.modelValue.slice(0);u.splice(l,1),t("update:modelValue",u),t("delete",a,p(l))},H=a=>{y.value=!0,g.value=a,$(()=>z())},X=()=>{y.value||(g.value=-1),y.value=!1},J=(a,l)=>{const u=["imageFit","deletable","reupload","previewSize","beforeDelete"],s=x(k(e,u),k(a,u,!0));return r(ye,Z({item:a,index:l,onClick:()=>t(e.reupload?"clickReupload":"clickPreview",a,p(l)),onDelete:()=>_(a,l),onPreview:()=>I(a),onReupload:()=>H(l)},k(e,["name","lazyLoad"]),s),k(i,["preview-cover","preview-delete"]))},K=()=>{if(e.previewImage)return e.modelValue.map(J)},V=a=>t("clickUpload",a),Q=()=>{if(e.modelValue.length>=+e.maxCount&&!e.reupload)return;const a=e.modelValue.length>=+e.maxCount&&e.reupload,l=e.readonly?null:r("input",{ref:c,type:"file",class:o("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&g.value===-1,disabled:e.disabled,onChange:f,onClick:X},null);return i.default?j(r("div",{class:o("input-wrapper"),onClick:V},[i.default(),l]),[[D,!a]]):j(r("div",{class:o("upload",{readonly:e.readonly}),style:T(e.previewSize),onClick:V},[r(C,{name:e.uploadIcon,class:o("upload-icon")},null),e.uploadText&&r("span",{class:o("upload-text")},[e.uploadText]),l]),[[D,e.showUpload&&!a]])},z=()=>{c.value&&!e.disabled&&c.value.click()};return Y(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),oe({chooseFile:z,closeImagePreview:q}),ne(()=>e.modelValue),()=>r("div",{class:o()},[r("div",{class:o("wrapper",{disabled:e.disabled})},[K(),Q()])])}}),ke=fe(Pe),Se=ke;export{Se as V};
